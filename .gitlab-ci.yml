stages:
  - security_scan

variables:
  IMAGE_NAME: geosat
  IMAGE_TAG: 1.0.0
  # æ³¨æ„ï¼šçµå°¾è¦æœ‰æ–œç·šï¼Œä¾‹å¦‚ï¼šharbor.wistron.com/geoai/
  IMAGE_PATH: ${HARBOR_REGISTRY_PROJECT}${IMAGE_NAME}

cache:
  untracked: true
  paths:
    - node_modules/

# åªåœ¨ main çš„é€šç”¨è¦å‰‡ï¼ˆçµ¦ build ç”¨ï¼‰
.general:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

dependency_scan:
  stage: security_scan
  rules:
    - when: always
  tags: [k8s-runners]
  image: ${HARBOR_BASE_IMAGE_PATH}/gitlab-nexus-iq-pipeline:latest
  script:
    - echo "ğŸ”’ Running Nexus IQ policy evaluation..."
    - |
      /sonatype/evaluate \
      -s $NEXUS_IQ_URL \
      -a $NEXUS_IQ_USERNAME:$NEXUS_IQ_PASSWORD \
      -i ${IMAGE_NAME} \
      -t build \
      -r scan-result.json \
      .
  artifacts:
    paths: ['scan-result.json']
    when: always
  allow_failure: true
